# EpumpBot
First, the Bot starts and sets the webhook address. Incoming updates are received via the Webhook Controller.
HandleUpdateService.cs handles all incoming updates- there are various types. It is the backbone of the application.

Ensure to read the [Telegram Bot API Documentation](https://core.telegram.org/bots/api). Also refer to the [C# Bot Library](https://github.com/TelegramBots/Telegram.Bot).

# How to run locally
Install [ngrok](https://ngrok.com/) and add it to PATH, for simplicity.   
Paste `ngrok http https://localhost:port` into the terminal. Port is the port number the server listens on.
Telegram currently supports a few [ports for webhooks](https://core.telegram.org/bots/api#:~:text=Ports%20currently%20supported%20for%20Webhooks%3A%20443%2C%2080%2C%2088%2C%208443.).   
The https address generated by ngrok will serve as the Webhook Url in the appsettings.Development.json file. The webhook runs on the same server as the Bot.

# HandleUpdateService.cs
`EchoAsync` determines the update type and passes it to the function which handles it.   
Callback Queries are requests sent by the Bot to itself. The callback data is used in hand with the DB to track state- hence the large number of switch statements.

`BotOnCallbackQueryReceived()` uses the callbacks to give the illusion of a menu as different keyboards are displayed in response to user selections.   
I think the rest is pretty self explanatory.

# BranchReportsKeyboards.cs
Branch Reports follow a specific pattern.
1. They show an ordered list of all branches in the company.
2. They send the branchId of the user's selection as a callback query.
3. They set state for the respective report.
   
The bot checks the `CheckState(CallbackQuery query)` method and routes to the correct function. Next, it stores the current branch Id in the DB before prompting the user to select a date. It sets a new state and routes to the function which actually sends the report.   
Finally, the date selected is converted to a DateTime object, the request is constructed and sent; the document is sent to the user.

In some cases, a report requires a specific input- such as a single date.   
Here, `CheckState(Message message)` receives the request and passes the message to a function that receives and interprets it.

# Other Stuff

